version: "{build}"

image: 
  - Visual Studio 2017
  - Ubuntu1804

install:
  - sh: cd $APPVEYOR_BUILD_FOLDER
  - cmd: cd %APPVEYOR_BUILD_FOLDER%
  - git submodule update --init --recursive
  # Windows vcpkg export  
  - cmd: powershell if(![System.IO.Directory]::Exists('c:\tools\prebuild')) { mkdir c:\tools\prebuild }
  - cmd: cd c:\tools\prebuild
  - cmd: powershell if(![System.IO.File]::Exists('vcpkg-export-x64-windows-static.7z')) { Invoke-WebRequest https://github.com/TheWillard/ci-toolchains/raw/master/vcpkg-export-x64-windows-static.7z -OutFile vcpkg-export-x64-windows-static.7z }
  - cmd: 7z x vcpkg-export-x64-windows-static.7z
  - cmd: cd %APPVEYOR_BUILD_FOLDER%
  # Linux vcpkg export
  - sh: mkdir -p $HOME/deps
  - sh: cd $HOME/deps/
  - sh: appveyor DownloadFile https://github.com/TheWillard/ci-toolchains/raw/master/vcpkg-export-x64-linux.7z
  - sh: 7z x vcpkg-export-x64-linux.7z > /dev/null
  - sh: cd $APPVEYOR_BUILD_FOLDER

before_build:
  # Windows CMake
  - cmd: mkdir build
  - cmd: mkdir vcproj64
  - cmd: cd vcproj64
  - cmd: cmake .. -G "Visual Studio 15 2017 Win64" -DUSE_64BIT_BUILD=ON -DVCPKG_TARGET_TRIPLET=x64-windows-static -DCMAKE_TOOLCHAIN_FILE=c:/tools/prebuild/vcpkg-export-20190519-024108/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows-static
  - cmd: cd ..
  # Linux CMake
  - sh: whereis boost
  - sh: CXX=g++-8 CC=gcc-8 cmake . -DCMAKE_TOOLCHAIN_FILE=$HOME/deps/vcpkg-export-x64-linux/scripts/buildsystems/vcpkg.cmake

build:
  parallel: true
  verbosity: minimal

build_script:
  # Windows Build
  - cmd: msbuild vcproj64\grad_replay_intercept.sln /m 
  - cmd: tools\hemtt.exe build
  # Linux Build
  - sh: make
  - sh: ./tools/hemtt build
  
after_build:
  - cmd: powershell .\tools\packageWindows.ps1
  - sh: ./tools/packageLinux.sh

artifacts:
  - path: build\win64
    name: win64
  - path: src\grad_replay_intercept_x64.so
    name: linux64
  - path: addons\grad_replay_intercept.pbo
    name: grad_replay_intercept_pbo

for:
-
  branches:
    only:
      - master
  
  deploy:
    - provider: GitHub
      auth_token:
        secure: MXV97Ngzyn/C/TrCbWG4tdIZcxS/rTfojUq45KbgspSafhcTut3HseMq2002oYkg
      artifact: zip
      draft: false
      prerelease: false
      force_update: true
      skip_tags: false
      on:
        APPVEYOR_REPO_TAG: true

  configuration: Release
  
-
  configuration: Debug
  
-  
  matrix:
    only:
      - image: Visual Studio 2017
  cache:
    - c:\tools\prebuild\vcpkg-export-x64-windows-static.7z
-
  matrix:
    only:
      - image: Ubuntu1804
  cache:
    - $HOME/deps/vcpkg-export-x64-linux.7z